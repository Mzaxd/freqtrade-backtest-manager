# K线图交易分析功能

## 功能概述

我们实现了一个强大的K线图交易分析功能，基于TradingView Lightweight Charts库，提供了类似于官方freqtradeUI的专业图表体验。

## 主要功能

### 1. 交互式K线图
- 使用TradingView Lightweight Charts渲染
- 支持多种时间框架（1分钟、5分钟、15分钟、1小时、4小时、日线）
- 可切换成交量显示
- 可切换网格显示
- 响应式设计，自适应屏幕大小

### 2. 交易标记
- **开仓标记**: 在K线下方显示三角形标记
  - 🟢 绿色表示盈利交易开仓
  - 🔴 红色表示亏损交易开仓
- **平仓标记**: 在K线上方显示倒三角形标记
  - 🟢 绿色表示盈利交易平仓
  - 🔴 红色表示亏损交易平仓

### 3. 交互功能
- **鼠标悬停**: 显示K线的详细价格信息（开、高、低、收）
- **点击标记**: 点击交易标记显示详细信息
- **十字线**: 实时显示价格和时间信息
- **缩放和平移**: 支持图表缩放和时间轴平移

### 4. 交易详情面板
- 当点击交易标记时，显示完整的交易信息：
  - 交易对
  - 开仓/平仓价格
  - 盈亏百分比
  - 持仓时长
  - 平仓原因

### 5. 控制面板
- **时间框架切换**: 快速切换不同的K线周期
- **显示选项**: 切换成交量和网格显示
- **刷新功能**: 重新加载图表数据
- **导出功能**: 导出图表为图片（待实现）

## 技术实现

### 组件结构
```
src/
├── components/
│   ├── CandlestickChart.tsx          # 核心K线图组件
│   ├── EnhancedTradingChart.tsx       # 增强的交易图表组件
│   └── BacktestDetail/
│       └── page.tsx                   # 集成到回测详情页面
└── app/
    └── api/
        └── backtests/
            └── [id]/
                └── chart-data/
                    └── route.ts         # K线数据API端点
```

### 数据流程
1. **数据获取**: 从freqtrade回测结果文件中读取K线数据
2. **数据转换**: 将原始数据转换为TradingView格式
3. **图表渲染**: 使用Lightweight Charts渲染K线图
4. **交易标记**: 在图表上标记开仓/平仓点
5. **交互处理**: 处理用户交互事件

### 关键特性
- **TypeScript支持**: 完整的类型定义
- **响应式设计**: 适配不同屏幕尺寸
- **性能优化**: 按需加载和数据缓存
- **可扩展性**: 易于添加新的技术指标

## 使用方法

1. 在回测详情页面，点击"K线图"标签
2. 选择想要查看的时间框架
3. 鼠标悬停查看K线详细信息
4. 点击交易标记查看交易详情
5. 使用控制面板自定义显示选项

## 未来改进

### 短期目标
- [ ] 实现图表导出功能
- [ ] 添加更多技术指标（MA、RSI、MACD等）
- [ ] 支持多图表对比
- [ ] 添加绘图工具（趋势线、水平线等）

### 长期目标
- [ ] 实现实时数据流
- [ ] 添加策略回测功能
- [ ] 支持更多图表类型
- [ ] 实现云端数据同步

## 依赖项

- `lightweight-charts`: TradingView Lightweight Charts库
- `react`: React框架
- `next-intl`: 国际化支持
- `tailwindcss`: 样式框架

## 注意事项

1. 目前K线数据主要来源于模拟数据，实际项目中应该从freqtrade的结果文件中读取
2. 图表性能依赖于数据量，大量数据时可能需要优化
3. 浏览器兼容性需要进一步测试

## 截图展示

*（待添加功能截图）*

---

这个功能大大提升了回测结果的可视化体验，让用户能够更直观地分析交易策略的表现。